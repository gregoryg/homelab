<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2021-07-13 Tue 07:30 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>&lrm;</title>
<meta name="generator" content="Org mode" />
<meta name="author" content="Gregory Grubbs" />
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #ccc;
    box-shadow: 3px 3px 3px #eee;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: auto;
    padding-top: 1.2em;
  }
  pre.src:before {
    display: none;
    position: absolute;
    background-color: white;
    top: -10px;
    right: 10px;
    padding: 3px;
    border: 1px solid black;
  }
  pre.src:hover:before { display: inline; margin-top: 14px;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .equation-container {
    display: table;
    text-align: center;
    width: 100%;
  }
  .equation {
    vertical-align: middle;
  }
  .equation-label {
    display: table-cell;
    text-align: right;
    vertical-align: middle;
  }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { width: 90%; }
  /*]]>*/-->
</style>
<link rel="stylesheet" type="text/css" href="https://fniessen.github.io/org-html-themes/src/readtheorg_theme/css/htmlize.css"/>
<link rel="stylesheet" type="text/css" href="https://fniessen.github.io/org-html-themes/src/readtheorg_theme/css/readtheorg.css"/>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>
<script type="text/javascript" src="https://fniessen.github.io/org-html-themes/src/lib/js/jquery.stickytableheaders.min.js"></script>
<script type="text/javascript" src="https://fniessen.github.io/org-html-themes/src/readtheorg_theme/js/readtheorg.js"></script>
<script type="text/javascript">
// @license magnet:?xt=urn:btih:1f739d935676111cfff4b4693e3816e664797050&amp;dn=gpl-3.0.txt GPL-v3-or-Later
<!--/*--><![CDATA[/*><!--*/
     function CodeHighlightOn(elem, id)
     {
       var target = document.getElementById(id);
       if(null != target) {
         elem.classList.add("code-highlighted");
         target.classList.add("code-highlighted");
       }
     }
     function CodeHighlightOff(elem, id)
     {
       var target = document.getElementById(id);
       if(null != target) {
         elem.classList.remove("code-highlighted");
         target.classList.remove("code-highlighted");
       }
     }
    /*]]>*///-->
// @license-end
</script>
<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        displayAlign: "center",
        displayIndent: "0em",

        "HTML-CSS": { scale: 100,
                        linebreaks: { automatic: "false" },
                        webFont: "TeX"
                       },
        SVG: {scale: 100,
              linebreaks: { automatic: "false" },
              font: "TeX"},
        NativeMML: {scale: 100},
        TeX: { equationNumbers: {autoNumber: "AMS"},
               MultLineWidth: "85%",
               TagSide: "right",
               TagIndent: ".8em"
             }
});
</script>
<script type="text/javascript"
        src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS_HTML"></script>
</head>
<body>
<div id="content">
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#org7796362">1. Longhorn on k3s in place of local path provisioner</a>
<ul>
<li><a href="#org9a92c4a">1.1. Infrastructure</a>
<ul>
<li><a href="#orgf22e99c">1.1.1. Primary cluster</a></li>
<li><a href="#org041e555">1.1.2. Secondary cluster</a></li>
</ul>
</li>
<li><a href="#orgb4a3cab">1.2. Bootstrapping primary cluster using K3sup</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div id="outline-container-org7796362" class="outline-2">
<h2 id="org7796362"><span class="section-number-2">1.</span> Longhorn on k3s in place of local path provisioner</h2>
<div class="outline-text-2" id="text-1">
</div>
<div id="outline-container-org9a92c4a" class="outline-3">
<h3 id="org9a92c4a"><span class="section-number-3">1.1.</span> Infrastructure</h3>
<div class="outline-text-3" id="text-1-1">
</div>
<div id="outline-container-orgf22e99c" class="outline-4">
<h4 id="orgf22e99c"><span class="section-number-4">1.1.1.</span> Primary cluster</h4>
<div class="outline-text-4" id="text-1-1-1">
<p>
Six nodes - one Kubernetes control node (control0) and five workers (worker{0..5})
</p>

<p>
Worker nodes worker{0..3} have a second 100GB disk attached as /dev/sdb for use by Longhorn
</p>
</div>
</div>

<div id="outline-container-org041e555" class="outline-4">
<h4 id="org041e555"><span class="section-number-4">1.1.2.</span> Secondary cluster</h4>
<div class="outline-text-4" id="text-1-1-2">
<p>
Vanilla install of Kubernetes and Longhorn.  Ideally one deployed at a separate site.
</p>
</div>
</div>
</div>

<div id="outline-container-orgb4a3cab" class="outline-3">
<h3 id="orgb4a3cab"><span class="section-number-3">1.2.</span> Bootstrapping primary cluster using K3sup</h3>
<div class="outline-text-3" id="text-1-2">
<p>
Using k3sup, control node first:
</p>
<div class="org-src-container">
<pre class="src src-bash">k3sup install --ip $<span style="color: #e91e63;">(</span><span style="color: #FFA000; font-style: italic;">govc vm.ip /int/vm/control0</span><span style="color: #e91e63;">)</span> <span style="color: #689f38;">\</span>
  --user nick --local-path ~/.kube/longhorn.yaml --context longhorn <span style="color: #689f38;">\</span>
  --k3s-version v1.19.7+k3s1 --k3s-extra-args <span style="color: #689f38;">\</span>
  <span style="color: #689f38;">'--node-taint CriticalAddonsOnly=true:NoExecute --no-deploy local-storage'</span>
</pre>
</div>
<p>
Then the worker nodes:
</p>

<p>
for worker in $(for node in $(govc ls /int/vm | grep worker) ; do govc vm.ip $node ; done) ; do \
  echo $worker ; done | parallel -v -I% k3sup join &#x2013;ip % &#x2013;server-ip $(govc vm.ip /int/vm/control0) \
  &#x2013;user nick &#x2013;k3s-version v1.19.7+k3s1
Create and mount filesystems:
pssh -i -H "`govc vm.ip /int/vm/worker{0..2} | tr '\n' ' '`" \
  'sudo mkfs.ext4 /dev/sdb ; sudo mkdir -p /longhorn ; sudo mount /dev/sdb /longhorn'
Install Longhorn
Before installing Longhorn, we need to label and annotate these nodes so that Longhorn uses them for storage:
</p>

<p>
for node in worker{0..2} ; do \
  kubectl label node/$node node.longhorn.io/create-default-disk='config' ; done
for node in worker{0..2} ; do \
  kubectl annotate node/$node node.longhorn.io/default-disks-config='[{"path":"/longhorn", "allowScheduling":true}]' ; done
</p>


<p>
From the Cluster Explorer → Apps → Longhorn, install Longhorn into the ‘system’ project. Check the option under ‘Longhorn Default Settings’ to ‘Customize Default Settings’ and select the option to ‘Create Default Disk on Labelled Nodes'. This is so that our nodes with the additional disk attached are used by Longhorn:
</p>



<p>
Configuring Backups
Minio
In order to use Minio hosted externally, the Secret to be created needs to include the AWS_ENDPOINTS key set to the right URL. Intuitively you’d think that this can be done in the Settings UI as part of the S3 URL, but it turns out that doesn’t work. Example:
</p>



<p>
kubectl create secret generic minio-backup \
&#x2013;from-file=AWS_ACCESS_KEY_ID=./AWS_ACCESS_KEY_ID.txt \
&#x2013;from-file=AWS_SECRET_ACCESS_KEY=./AWS_SECRET_ACCESS_KEY.txt \
&#x2013;from-literal=AWS_ENDPOINTS=<a href="https://syn.int.dischord.org:9000">https://syn.int.dischord.org:9000</a>
S3
Encode your access key and secret key as base64, and then populate aws-secret.yaml:
</p>

<p>
$ echo -n accesskey1234 | base64
YWNjZXNza2V5MTIzNA==
$ echo -n secretkey1234 | base64
c2VjcmV0a2V5MTIzNA==
aws-secret.yaml:
</p>

<p>
apiVersion: v1
kind: Secret
metadata:
  name: aws-secret
  namespace: longhorn-system
type: Opaque
data:
  AWS_ACCESS_KEY_ID: YWNjZXNza2V5MTIzNA==
  AWS_SECRET_ACCESS_KEY: c2VjcmV0a2V5MTIzNA==
$ kubectl apply -f aws-secret.yaml
secret/aws-secret created
</p>


<p>
Demo flow
Show two clusters - one with Longhorn installed, one without
Install Longhorn on second cluster - demonstrate labelled nodes and dedicated disks as per setup above
Show Longhorn dashboard
Deploy Wordpress via Rancher App Catalogue - PVs for Wordpress and MariaDB
Show volumes in Longhorn dashboard
Create snapshot, setup backup - Longhorn settings, create backup secret first, set S3 target
Login to Wordpress, create some content
Create another snapshot
Scale MariaDB workload down to 0
Roll back snapshot - attach volume to host first in maintenance mode, select snapshot revision pre-changes, detach volume
Scale MariaDB back up and wait for Wordpress to come back online
Show Wordpress content pre-changes
On second cluster, setup backup target as per first
Create DR volume
Show launching MariaDB from activated DR volume
</p>


<p>
Activating DR
When installing Wordpress, take a note of the MariaDB root password.  When activating DR you'll need to install MariaDB directly using its Helm chart so that you can specify the root password to use:
</p>

<p>
helm install mariadb bitnami/mariadb &#x2013;namespace wordpress \
&#x2013;set primary.persistence.existingClaim=data-wordpress-mariadb-0 \
&#x2013;set primary.persistence.enabled=true \
&#x2013;set auth.rootPassword=6c41b661-8c3e \
&#x2013;set image.debug=true \
&#x2013;set image.tag=10.3.22-debian-10-r44 \
&#x2013;set secondary.replicaCount=0
</p>


<p>
Appendix
Anticipated questions
“What’s the difference between backups and snapshots?”
</p>

<p>
Snapshots can store historical data for the volume. They are a part of Longhorn volumes, which means they will be deleted if the volume is gone.
</p>

<p>
Backups are the data stored in external storage like S3 or NFS. When the volume or even your whole Longhorn cluster somehow crashes, you can use the backups to restore data to new volumes later.
</p>

<p>
Example Resources
RWX example:
</p>

<p>
apiVersion: v1
kind: Service
metadata:
  name: rwx-test
  labels:
    app: rwx-test
spec:
  ports:
</p>
<ul class="org-ul">
<li>port: 80</li>
</ul>
<p>
  selector:
    app: rwx-test
&#x2014;
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: rwx-test
  namespace: default
spec:
  accessModes:
</p>
<ul class="org-ul">
<li>ReadWriteMany</li>
</ul>
<p>
  storageClassName: longhorn
  resources:
    requests:
      storage: 1Gi
&#x2014;
apiVersion: apps/v1
kind: Deployment
metadata:
  name: rwx-test
  labels:
    app: rwx-test
  namespace: default
spec:
  replicas: 3
  selector:
    matchLabels:
      app: rwx-test
  strategy:
    type: Recreate
  template:
    metadata:
      labels:
        app: rwx-test
    spec:
      containers:
</p>
<ul class="org-ul">
<li><p>
image: ubuntu:xenial
imagePullPolicy: IfNotPresent
command: [ "/bin/sh", "-c" ]
args:
</p>
<ul class="org-ul">
<li>sleep 10; touch /data/index.html; while true; do date &gt;&gt; /data/index.html; sleep 1; done;</li>
</ul>
<p>
name: rwx-test
stdin: true
tty: true
volumeMounts:
</p>
<ul class="org-ul">
<li>mountPath: /data
name: rwx-test</li>
</ul></li>
<li><p>
image: nginx:stable
imagePullPolicy: IfNotPresent
name: nginx
ports:
</p>
<ul class="org-ul">
<li>containerPort: 80
name: http</li>
</ul>
<p>
volumeMounts:
</p>
<ul class="org-ul">
<li>mountPath: /usr/share/nginx/html
name: rwx-test</li>
</ul></li>
</ul>
<p>
restartPolicy: Always
volumes:
</p>
<ul class="org-ul">
<li>name: rwx-test
persistentVolumeClaim:
  claimName: rwx-test</li>
</ul>
<p>
&#x2014;
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  annotations:
    kubernetes.io/ingress.class: traefik
    cert-manager.io/cluster-issuer: letsencrypt
  name: rwx-test
  namespace: default
spec:
  rules:
</p>
<ul class="org-ul">
<li>host: "rwx-test.192.168.1.27.dnsify.me"
http:
  paths:
<ul class="org-ul">
<li>pathType: Prefix
path: "/"
backend:
  service:
    name: rwx-test
    port:
      number: 80</li>
</ul></li>
</ul>
</div>
</div>
</div>
</div>
<div id="postamble" class="status">
<p class="author">Author: Gregory Grubbs</p>
<p class="date">Created: 2021-07-13 Tue 07:30</p>
<p class="validation"><a href="https://validator.w3.org/check?uri=referer">Validate</a></p>
</div>
</body>
</html>
